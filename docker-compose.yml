services:
  ffmpeg:
    image: lscr.io/linuxserver/ffmpeg:latest
    environment:
      ICECAST_URL: "https://icecast-u3.play.cz/cro1-128.mp3"
    entrypoint: ["/bin/sh", "/app/run-ffmpeg.sh"]
    volumes:
      - /Users/ladasoukup/.tmpdisk/tmp/cro:/output
      - ./run-ffmpeg.sh:/app/run-ffmpeg.sh:ro
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "test -f /output/dash/manifest.mpd && test -f /output/hls/playlist.m3u8 && now=$(date +%s) && mod_dash=$(stat -c %Y /output/dash/manifest.mpd 2>/dev/null || stat -f %m /output/dash/manifest.mpd) && mod_hls=$(stat -c %Y /output/hls/playlist.m3u8 2>/dev/null || stat -f %m /output/hls/playlist.m3u8) && [ $((now - mod_dash)) -lt 180 ] && [ $((now - mod_hls)) -lt 180 ]",
        ]
      interval: 1m
      timeout: 10s
      retries: 3
      start_period: 2m

  nginx:
    image: nginx:latest
    volumes:
      - /Users/ladasoukup/.tmpdisk/tmp/cro:/usr/share/nginx/html:ro
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    ports:
      - "8080:80"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/heartbeat.txt"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
