server {
    listen 80;
    server_name _;

    root /usr/share/nginx/html;
    index index.html;

    # CORS & common security headers (adjust as needed)
    add_header Access-Control-Allow-Origin "*" always;
    add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Origin, Range, If-Modified-Since, Cache-Control, Pragma, Accept, Referer, User-Agent" always;
    add_header Vary "Origin" always;
    add_header X-Content-Type-Options nosniff always;
    add_header X-Frame-Options DENY always;
    add_header Referrer-Policy no-referrer-when-downgrade always;

    # DASH manifest (.mpd) - serve from /dash/ subfolder
    location ~* \/dash\/[^/]+\.mpd$ {
        add_header Cache-Control "public, max-age=5, must-revalidate";
        add_header Access-Control-Allow-Origin "*" always;
        add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Origin, Range, If-Modified-Since, Cache-Control, Pragma, Accept, Referer, User-Agent" always;
        add_header Access-Control-Expose-Headers "Content-Length, Content-Range";
        add_header Vary "Origin" always;
        default_type application/dash+xml;
        if ($request_method = OPTIONS) { return 204; }
        try_files $uri =404;
    }

    # DASH segments (.m4s) - serve from /dash/ subfolder
    location ~* \/dash\/[^/]+\.m4s$ {
        add_header Cache-Control "public, max-age=30, immutable";
        add_header Access-Control-Allow-Origin "*" always;
        add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Origin, Range, If-Modified-Since, Cache-Control, Pragma, Accept, Referer, User-Agent" always;
        add_header Access-Control-Expose-Headers "Content-Length, Content-Range";
        add_header Vary "Origin" always;
        if ($request_method = OPTIONS) { return 204; }
        try_files $uri =404;
    }

    # HLS manifest (.m3u8) - serve from /hls/ subfolder
    location ~* \/hls\/[^/]+\.m3u8$ {
        add_header Cache-Control "public, max-age=5, must-revalidate";
        add_header Access-Control-Allow-Origin "*" always;
        add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Origin, Range, If-Modified-Since, Cache-Control, Pragma, Accept, Referer, User-Agent" always;
        add_header Access-Control-Expose-Headers "Content-Length, Content-Range";
        add_header Vary "Origin" always;
        default_type application/vnd.apple.mpegurl;
        if ($request_method = OPTIONS) { return 204; }
        try_files $uri =404;
    }

    # HLS segments (.ts) - serve from /hls/ subfolder
    location ~* \/hls\/[^/]+\.ts$ {
        add_header Cache-Control "public, max-age=30, immutable";
        add_header Access-Control-Allow-Origin "*" always;
        add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Origin, Range, If-Modified-Since, Cache-Control, Pragma, Accept, Referer, User-Agent" always;
        add_header Access-Control-Expose-Headers "Content-Length, Content-Range";
        add_header Vary "Origin" always;
        default_type video/mp2t;
        if ($request_method = OPTIONS) { return 204; }
        try_files $uri =404;
    }

    # Generic OPTIONS handler for root assets
    location / {
        if ($request_method = OPTIONS) {
            add_header Access-Control-Allow-Origin "*" always;
            add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Origin, Range, If-Modified-Since, Cache-Control, Pragma, Accept, Referer, User-Agent" always;
            add_header Content-Length 0;
            add_header Content-Type text/plain;
            return 204;
        }
        try_files $uri $uri/ =404;
    }

    # Dynamic heartbeat (no file needed) always 200 with minimal body
    location = /heartbeat.txt {
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        default_type text/plain;
        return 200 'OK';
    }
}
